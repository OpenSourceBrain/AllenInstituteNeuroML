<Lems>

    <!-- Initial ideas for expressing GLIF model in LEMS/NeuroML2 -->


    <Target component="sim1" />

    <!-- Include core NeuroML2 ComponentType definitions -->
    <Include file="Cells.xml" />
    <Include file="Networks.xml" />
    <Include file="Simulation.xml" />



    <ComponentType name="glifCell"
        extends="baseIafCapCell"
        description="GLIF...">

        <Parameter name="leakConductance" dimension="conductance"/>
        <Parameter name="leakReversal" dimension="voltage"/>
        
        <Parameter name="tau1" dimension="time"/>
        <Parameter name="tau2" dimension="time"/>
        <Parameter name="amp1" dimension="current"/>
        <Parameter name="amp2" dimension="current"/>
        
        <Exposure name="asc1" dimension="current" description="After-spike current 1"/>
        <Exposure name="asc2" dimension="current" description="After-spike current 2"/>

        <Attachments name="synapses" type="basePointCurrent"/>

        <Dynamics>

            <StateVariable name="v" exposure="v" dimension="voltage"/>
            
            <StateVariable name="asc1" exposure="asc1" dimension="current"/>
            <StateVariable name="asc2" exposure="asc2" dimension="current"/>

            <DerivedVariable name="iSyn" dimension="current" exposure="iSyn" select="synapses[*]/i" reduce="add" />
            <DerivedVariable name="iMemb" dimension="current" exposure="iMemb" value="leakConductance * (leakReversal - v) + asc1 + asc2 + iSyn"/>

            <TimeDerivative variable="v" value="iMemb / C"/>
            <TimeDerivative variable="asc1" value="-1 * asc1 / tau1"/>
            <TimeDerivative variable="asc2" value="-1 * asc2 / tau2"/>

            <OnStart>
                <StateAssignment variable="v" value="leakReversal"/>
            </OnStart>

            <OnCondition test="v .gt. thresh">
                <StateAssignment variable="asc1" value="asc1 + amp1"/>
                <StateAssignment variable="asc2" value="asc2 + amp2"/>
                <StateAssignment variable="v" value="reset"/>
                <EventOut port="spike"/>
            </OnCondition>

        </Dynamics>

    </ComponentType>

    <glifCell id="glif_480629471" leakReversal="0mV" thresh=" 0.01982398 V" tau1="1ms" tau2="1ms" amp1="0A" amp2="0A"
	     reset="0mV" C="4.946777501212259e-11 F" leakConductance="2.2833678368091756e-09 S"/>
    
    <glifCell id="glif_480629475" leakReversal="0mV" thresh="0.016535833531715175 V"  tau1="0.03333333333s" tau2="0.00333333333s"
     amp1="-3.847001287818176e-11A" amp2="2.058989164357654e-10A"
	     reset="0mV" C="4.946777501212259e-11 F" leakConductance="2.2833678368091756e-09 S"/>

    <pulseGenerator id="pulseGen0" delay="100ms" duration="1000ms" amplitude="50 pA" />

    <network id="net1">
        <population id="pop1" component="glif_480629471" size="1" />
        <population id="pop2" component="glif_480629475" size="1" />
        <explicitInput target="pop1[0]" input="pulseGen0" destination="synapses"/>
        <explicitInput target="pop2[0]" input="pulseGen0" destination="synapses"/>
    </network>

    <!-- End of NeuroML2 content -->


    <Simulation id="sim1" length="1200ms" step="0.05ms" target="net1">

        <Display id="d1" title="Ex GLIF" timeScale="1ms" xmin="-100" xmax="1300" ymin="-80" ymax="50">
            <Line id="v" quantity="pop1[0]/v" scale="1mV" color="#ffffff" timeScale="1ms" />
        </Display>
        <Display id="d2" title="Ex GLIF 2" timeScale="1ms" xmin="-100" xmax="1300" ymin="-80" ymax="50">
            <Line id="v" quantity="pop2[0]/v" scale="1mV" color="#ffffff" timeScale="1ms" />
        </Display>
        <Display id="d3" title="Ex GLIF currents" timeScale="1ms" xmin="-100" xmax="1300" ymin="-80" ymax="50">
            <Line id="asc1" quantity="pop2[0]/asc1" scale="1nA" color="#ffffff" timeScale="1ms" />
            <Line id="asc2" quantity="pop2[0]/asc2" scale="1nA" color="#33ffff" timeScale="1ms" />
        </Display>
    

    </Simulation>


</Lems>